<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Biblioth√®que ‚Äì En Roue Livre</title>

<!-- CSS -->
<link rel="stylesheet" href="styles.css">

</head>
<body id="top">

<!-- HEADER -->
<div class="hero-section">
  <div class="header">
    <h1>Parcourez la biblioth√®que En Roue Livre !</h1>
  </div>
</div>

<!-- RECHERCHE -->
<div class="search-zone">
  <input type="search" id="searchInput" placeholder="Rechercher par titre‚Ä¶">
  <button id="searchButton" onclick="rechercherTitre()">üîç</button>

  <input type="search" id="searchInputAuteur" placeholder="Rechercher par auteur‚Ä¶">
  <button onclick="rechercherAuteur()">üîç</button>

  <input type="search" id="searchInputGenre" placeholder="Rechercher par genre‚Ä¶">
  <button onclick="rechercherGenre()">üîç</button>

  <div id="noResultMessage">Pas de r√©sultat</div>
</div>

<!-- TABLE -->
<table id="tableLivres">
  <tr>
    <th>Couverture</th>
    <th id="detail_titre" onclick="toggleAllDetails()">Titre / Auteur(s)</th>
  </tr>
</table>

<h3 id="nombreTitres">Nombre de titres : 0</h3>
<button id="showAllButton" onclick="afficherTout()">Afficher tout</button>

<br><br>

<h2 class="footer">
  Catalogue g√©n√©r√© avec
  <a href="https://www.soft-creation.fr/MesLivresPro.html" target="_blank">Mes Livres Pro</a>
</h2>

<a name="down"></a>

<!-- SCRIPT -->
<script>
let detailsVisible = false;
let searchActive = false;
let currentIndex = 0;
const CHUNK_SIZE = 50;

/* ---------- HELPERS ---------- */
function decode(str){
  const t = document.createElement("textarea");
  t.innerHTML = str || "";
  return t.value;
}
function norm(str){
  return decode(str).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

/* ---------- TOGGLE DETAILS ---------- */
function toggleDetails(id){
  const el = document.getElementById(id);
  const expanded = el.dataset.expanded === "true";

  if(expanded){
    el.innerHTML = el.dataset.display;
    el.dataset.expanded = "false";
  } else {
    el.innerHTML =
      `<b>Titre :</b> ${el.dataset.title}<br>
       <b>Auteur(s) :</b> ${el.dataset.auteur}<br>
       <b>ISBN :</b> ${el.dataset.isbn}<br>
       <b>Ann√©e :</b> ${el.dataset.annee}<br>
       <b>Genre :</b> ${el.dataset.genre}<br>
       <b>R√©sum√© :</b> ${el.dataset.resume}`;
    el.dataset.expanded = "true";
  }
}

function toggleAllDetails(){
  document.querySelectorAll("[id^='titre_']").forEach(td=>{
    if(detailsVisible !== (td.dataset.expanded==="true")){
      toggleDetails(td.id);
    }
  });
  detailsVisible = !detailsVisible;
}

/* ---------- CREATION LIGNE ---------- */
function createRow(livre){
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td class="col-image">
      <img class="lazyload" data-src="${livre.img}" alt="">
    </td>
    <td class="clickable"
        id="${livre.id}"
        data-expanded="false"
        data-display="${livre.display}"
        data-title="${decode(livre.titre)}"
        data-auteur="${decode(livre.data2)}"
        data-isbn="${livre.data3}"
        data-annee="${livre.data4}"
        data-genre="${decode(livre.data5)}"
        data-resume="${decode(livre.data6)}"
        onclick="toggleDetails('${livre.id}')">
        ${livre.display}
    </td>`;
  return tr;
}

/* ---------- LOAD CHUNKS ---------- */
function loadNextChunk(){
  if(searchActive) return;

  const end = Math.min(currentIndex + CHUNK_SIZE, allLivres.length);
  for(let i=currentIndex;i<end;i++){
    tableLivres.appendChild(createRow(allLivres[i]));
  }
  currentIndex = end;
  initLazyLoad();
}

/* ---------- SEARCH ---------- */
function searchBase(input, field){
  const q = norm(input.value);
  searchActive = q !== "";

  tableLivres.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());

  let results = q
    ? allLivres.filter(l=>norm(l[field]).includes(q))
    : allLivres;

  results.forEach(l=>tableLivres.appendChild(createRow(l)));
  initLazyLoad();

  nombreTitres.textContent = `Nombre de titres : ${results.length}`;
  noResultMessage.style.display = results.length ? "none":"block";
  showAllButton.style.display = q ? "block":"none";
}

function rechercherTitre(){ searchBase(searchInput,"titre"); }
function rechercherAuteur(){ searchBase(searchInputAuteur,"data2"); }
function rechercherGenre(){ searchBase(searchInputGenre,"data5"); }

function afficherTout(){
  searchActive = false;
  currentIndex = 0;
  tableLivres.querySelectorAll("tr:not(:first-child)").forEach(r=>r.remove());
  loadNextChunk();
  nombreTitres.textContent = `Nombre de titres : ${allLivres.length}`;
  showAllButton.style.display="none";
  noResultMessage.style.display="none";
}

/* ---------- LAZY LOAD ---------- */
function initLazyLoad(){
  const imgs = document.querySelectorAll("img.lazyload");
  const obs = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        const img=e.target;
        img.src=img.dataset.src;
        img.classList.remove("lazyload");
        obs.unobserve(img);
      }
    });
  });
  imgs.forEach(i=>obs.observe(i));
}

/* ---------- INIT ---------- */
window.addEventListener("load",()=>{
  nombreTitres.textContent = `Nombre de titres : ${allLivres.length}`;
  loadNextChunk();
});
</script>

<!-- ‚ö†Ô∏è GARDER TON TABLEAU allLivres ICI SANS CHANGER -->
<script src="allLivres.js"></script>

</body>
</html>
